name: Deploy to ECR and ECS

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'Dockerfile'
      - 'Dockerfile.nginx'
      - 'docker/**'
      - 'app/**'
      - 'config/**'
      - 'routes/**'
      - 'resources/**'
      - 'public/**'
      - '.github/workflows/deploy-ecr.yml'
  workflow_dispatch:
    inputs:
      tag:
        description: '任意のECRタグ（未指定ならlatest）'
        required: false
        type: string

env:
  AWS_REGION: ap-northeast-1

  # ECR repositories
  ECR_REPOSITORY_APP: laravel-app
  ECR_REPOSITORY_NGINX: laravel-nginx

  # ECS
  ECS_CLUSTER: dev-laravel-app-cluster
  ECS_SERVICE: dev-laravel-app-service
  ECS_TASK_DEFINITION_FAMILY: dev-laravel-app

  # ECS task definition container names (タスク定義内のcontainerDefinitions[].name)
  ECS_CONTAINER_NAME_APP: laravel-app
  ECS_CONTAINER_NAME_NGINX: laravel-nginx

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine image tag
        id: image-tag
        run: |
          TAG_INPUT="${{ github.event.inputs.tag }}"
          if [ -n "$TAG_INPUT" ]; then
            TAG="$TAG_INPUT"
          else
            TAG="latest"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using image tag: $TAG"

      - name: Build and push Laravel app image (tag)
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          set -euo pipefail
          APP_URI_TAG="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_APP }}:$IMAGE_TAG"
          echo "Building: $APP_URI_TAG"
          docker build --platform linux/amd64 -t "$APP_URI_TAG" -f Dockerfile .
          echo "Pushing: $APP_URI_TAG"
          docker push "$APP_URI_TAG"

      - name: Build and push nginx image (tag)
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          set -euo pipefail
          NGINX_URI_TAG="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_NGINX }}:$IMAGE_TAG"
          echo "Building: $NGINX_URI_TAG"
          docker build --platform linux/amd64 -t "$NGINX_URI_TAG" -f Dockerfile.nginx .
          echo "Pushing: $NGINX_URI_TAG"
          docker push "$NGINX_URI_TAG"

      - name: Build image URIs (use tag)
        id: image-uris
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          set -euo pipefail

          APP_URI_TAG="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_APP }}:$IMAGE_TAG"
          NGINX_URI_TAG="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_NGINX }}:$IMAGE_TAG"

          echo "app_image=$APP_URI_TAG" >> "$GITHUB_OUTPUT"
          echo "nginx_image=$NGINX_URI_TAG" >> "$GITHUB_OUTPUT"
          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"

          echo "Images (tag):"
          echo "  app:   $APP_URI_TAG"
          echo "  nginx: $NGINX_URI_TAG"

      - name: Install jq
        if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Fetch current task definition from service
        id: current-td
        if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
        run: |
          set -euo pipefail

          SERVICE_JSON="$(aws ecs describe-services \
            --cluster "${{ env.ECS_CLUSTER }}" \
            --services "${{ env.ECS_SERVICE }}" \
            --output json)"

          STATUS="$(echo "$SERVICE_JSON" | jq -r '.services[0].status')"
          DESIRED_STATUS="$(echo "$SERVICE_JSON" | jq -r '.services[0].desiredStatus')"
          CURRENT_TD_ARN="$(echo "$SERVICE_JSON" | jq -r '.services[0].taskDefinition')"

          echo "Service status: $STATUS (desiredStatus: $DESIRED_STATUS)"
          echo "Current service task definition: $CURRENT_TD_ARN"

          if [ "$STATUS" != "ACTIVE" ]; then
            echo "ERROR: ECS service is not ACTIVE. Cannot deploy."
            exit 1
          fi

          aws ecs describe-task-definition \
            --task-definition "$CURRENT_TD_ARN" \
            --query 'taskDefinition' \
            --output json > task-definition.json

          # register-task-definition で不要な読み取り専用フィールドを削除
          jq 'del(
                .taskDefinitionArn,
                .revision,
                .status,
                .requiresAttributes,
                .placementConstraints,
                .compatibilities,
                .registeredAt,
                .registeredBy
              )' task-definition.json > task-definition-clean.json

          echo "Current task definition images:"
          jq '.containerDefinitions[] | {name: .name, image: .image}' task-definition.json

      - name: Render task definition (app)
        id: render-app
        if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition-clean.json
          container-name: ${{ env.ECS_CONTAINER_NAME_APP }}
          image: ${{ steps.image-uris.outputs.app_image }}

      - name: Render task definition (nginx)
        id: render-nginx
        if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ steps.render-app.outputs.task-definition }}
          container-name: ${{ env.ECS_CONTAINER_NAME_NGINX }}
          image: ${{ steps.image-uris.outputs.nginx_image }}

      - name: Deploy ECS task definition (rolling)
        id: deploy
        if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.render-nginx.outputs.task-definition }}
          cluster: ${{ env.ECS_CLUSTER }}
          service: ${{ env.ECS_SERVICE }}
          wait-for-service-stability: true

      - name: Summary
        run: |
          echo "Deployment completed."
          echo "  tag:  ${{ steps.image-uris.outputs.image_tag }}"
          echo "  app:  ${{ steps.image-uris.outputs.app_image }}"
          echo "  nginx:${{ steps.image-uris.outputs.nginx_image }}"
          echo "  task: ${{ steps.deploy.outputs.task-definition-arn }}"
